
/**
 * @file Firestore Security Rules for Lexora Drafts application.
 *
 * Core Philosophy:
 * This ruleset prioritizes user authentication and data access control.
 * - Server actions (like creating a verification request) are permitted.
 * - Authenticated users can only read their own data.
 * - A designated lawyer has special privileges to review all verification requests.
 * - Public collections (templates, feed, glossary) are read-only for everyone.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    function isLawyer() {
      // The official lawyer's email address.
      return request.auth.token.email == 'lawyer@lexintel.com';
    }

    /**
     * @description Controls access to user profiles and their subcollections.
     * @path /users/{userId}
     */
    match /users/{userId} {
      function isOwner() {
        return request.auth.uid == userId;
      }

      // User profiles can only be read or written to by the owner.
      allow read, write: if isOwner();

      /**
       * @description Controls access to a user's recent activity log.
       * @path /users/{userId}/activities/{activityId}
       */
      match /activities/{activityId} {
        // Only the owner can read or write their own activity.
        allow read, write: if isOwner();
      }
    }
    
    /**
     * @description Controls access to lawyer profiles.
     * @path /lawyers/{lawyerId}
     */
    match /lawyers/{lawyerId} {
      function isOwner() {
        return request.auth.uid == lawyerId;
      }
      
      // Any authenticated user can read public lawyer profiles.
      allow get, list: if request.auth != null;
      
      // Only the owner can create or update their own profile.
      allow create, update: if isOwner();
      
      // Nobody can delete lawyer profiles.
      allow delete: if false;
    }

    /**
     * @description Public read access for templates, law feed, and glossary.
     */
    match /templates/{templateId} {
      allow get, list: if true;
      allow write: if false;
    }
    match /lawFeed/{updateId} {
      allow get, list: if true;
      allow write: if false;
    }
    match /glossary/{termId} {
      allow get, list: if true;
      allow write: if false;
    }
    
    /**
     * @description Controls access to draft verification requests.
     * @path /verificationRequests/{requestId}
     */
    match /verificationRequests/{requestId} {
      // Allow create if user is logged in OR if it's a server-side request.
      // request.time is non-null for server-side requests (server actions),
      // which allows them to bypass auth checks for writes.
      allow create: if request.auth != null || request.time != null;

      // The designated lawyer can list, read, update, and delete all requests.
      allow list, read, update, delete: if isLawyer();
      
      // A normal user can only GET their own requests (but cannot LIST all of them).
      // This rule is layered on top of the lawyer rule. A user request will be checked here first.
      allow get: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}
