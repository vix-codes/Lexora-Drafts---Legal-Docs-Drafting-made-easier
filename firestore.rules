rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /* ---------------------------------------
       Helper checks (kept simple)
    ---------------------------------------- */
    function isAuth() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isLawyerAdmin() {
      return request.auth != null &&
             request.auth.token.email == "lawyer@lexintel.com";
    }

    /* ---------------------------------------
       USERS COLLECTION
       (User can always read/write their own data)
    ---------------------------------------- */
    match /users/{userId} {
      allow read, write: if isOwner(userId);

      match /activities/{activityId} {
        allow read, write: if isOwner(userId);
      }

      match /approvedDrafts/{draftId} {
        allow read: if isOwner(userId);
        allow write: if false;
      }
    }

    /* ---------------------------------------
       LAWYERS COLLECTION
       (Public read, admin write)
    ---------------------------------------- */
    match /lawyers/{lawyerId} {
      allow get, list: if true;
      allow create, update: if isLawyerAdmin();
      allow delete: if false;
    }

    /* ---------------------------------------
       VERIFICATION REQUESTS
       (User creates, user reads own, admin full access)
    ---------------------------------------- */
    match /verificationRequests/{requestId} {
      // Anyone logged in can create a request
      allow create: if isAuth();

      // User can read their own request; lawyer admin can read all
      allow get, list: if isLawyerAdmin() ||
                       (request.auth != null &&
                        resource.data.userId == request.auth.uid);

      // Only admins can update (avoid user conflicts)
      allow update: if isLawyerAdmin();

      allow delete: if false;
    }

    /* ---------------------------------------
       PUBLIC READ COLLECTIONS
    ---------------------------------------- */
    match /templates/{id} {
      allow get, list: if true;
    }

    match /lawFeed/{id} {
      allow get, list: if true;
    }

    match /glossary/{id} {
      allow get, list: if true;
    }

    /* ---------------------------------------
       Global protection: No deletes anywhere
    ---------------------------------------- */
    match /{doc=**} {
      allow delete: if false;
    }
  }
}
