
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
  
    // Helper functions
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }
    
    function isLawyerAdmin() {
      return request.auth != null && request.auth.token.email == 'lawyer@lexintel.com';
    }
    
    function isNewRequestValid(userId) {
      let incomingData = request.resource.data;
      return isOwner(userId) &&
             incomingData.userId == userId &&
             incomingData.status == 'pending' &&
             incomingData.lawyerComments.size() == 0 &&
             incomingData.createdAt == request.time &&
             incomingData.updatedAt == request.time;
    }

    // /users/{userId}
    match /users/{userId} {
      // Users can only access their own document
      allow read, write: if isOwner(userId);
      
      // Users can create activity logs under their own document
      match /activities/{activityId} {
        allow create: if isOwner(userId);
        allow read, update, delete: if false; // Logs are immutable
      }
      
      // Users can read their own approved drafts
      match /approvedDrafts/{draftId} {
          allow read: if isOwner(userId);
          allow create, update, delete: if false; // Created by admin action
      }
    }
    
    // /lawyers/{lawyerId}
    match /lawyers/{lawyerId} {
        // Anyone can read verified lawyer profiles
        allow get: if resource.data.isVerified == true;
        // The collection can be listed by anyone (to show all lawyers)
        allow list: if true;
        // Only lawyer admin can create or update lawyer profiles
        allow create, update: if isLawyerAdmin();
        allow delete: if false;
    }
    
    // /verificationRequests/{requestId}
    match /verificationRequests/{requestId} {
        // CREATE: A user can create a verification request for themselves.
        allow create: if isNewRequestValid(request.resource.data.userId);

        // READ: 
        // A user can read their own requests.
        // The lawyer admin can read all requests.
        allow get, list: if isOwner(resource.data.userId) || isLawyerAdmin();

        // UPDATE:
        // The lawyer admin can update any request (to add comments, change status).
        // A user can resubmit a 'reviewed' request.
        allow update: if isLawyerAdmin() || 
                      (isOwner(resource.data.userId) && resource.data.status == 'reviewed');
        
        // DELETE: No one can delete requests.
        allow delete: if false;
    }
  }
}
