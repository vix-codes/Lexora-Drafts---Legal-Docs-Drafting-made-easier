rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Helpers
    function isOwner(userId) {
      return request.auth != null && request.auth.uid == userId;
    }

    function isLawyerAdmin() {
      return request.auth != null 
             && request.auth.token.email == 'lawyer@lexintel.com';
    }

    // =====================================================
    // USERS COLLECTION
    // =====================================================
    match /users/{userId} {
      allow create, read, update: if isOwner(userId);
      allow delete: if false;

      match /activities/{activityId} {
        allow create, read: if isOwner(userId);
        allow update, delete: if false;
      }

      match /approvedDrafts/{draftId} {
        allow read: if isOwner(userId);
        allow create, update, delete: if false;
      }
    }

    // =====================================================
    // LAWYERS COLLECTION
    // =====================================================
    match /lawyers/{lawyerId} {
      // Public can read verified lawyers
      allow get, list: if true;

      // Only admin can create/update
      allow create, update: if isLawyerAdmin();
      allow delete: if false;
    }

    // =====================================================
    // VERIFICATION REQUESTS
    // =====================================================
    match /verificationRequests/{requestId} {

      // USER CAN CREATE their own request (simple, safe)
      allow create: if request.auth != null
                 && request.resource.data.userId == request.auth.uid;

      // USER CAN READ ONLY THEIR REQUEST
      allow get: if request.auth != null
              && resource.data.userId == request.auth.uid;

      // LAWYER CAN READ/LIST ALL
      allow get, list: if isLawyerAdmin();

      // LAWYER CAN UPDATE ANY REQUEST
      allow update: if isLawyerAdmin();

      // USER CAN UPDATE ONLY IF status == "reviewed"
      allow update: if request.auth != null
                 && resource.data.userId == request.auth.uid
                 && resource.data.status == "reviewed";

      allow delete: if false;
    }

    // =====================================================
    // PUBLIC READ-ONLY COLLECTIONS
    // =====================================================
    match /templates/{id} {
      allow get, list: if true;
      allow write: if false;
    }

    match /lawFeed/{id} {
      allow get, list: if true;
      allow write: if false;
    }

    match /glossary/{id} {
      allow get, list: if true;
      allow write: if false;
    }
  }
}
