rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * ============================================================
     *  HELPER FUNCTIONS
     * ============================================================
     */

    // Lawyer admin is identified ONLY by their email.
    function isLawyer() {
      return request.auth != null
             && request.auth.token.email == 'lawyer@lexintel.com';
    }

    // Checks if the logged-in user is the document owner.
    function isOwner(userId) {
      return request.auth != null
             && request.auth.uid == userId;
    }

    // Checks if user is authenticated.
    function isLoggedIn() {
      return request.auth != null;
    }

    /**
     * ============================================================
     *  USERS & ACTIVITIES
     * ============================================================
     * A user may only read or write their OWN profile and activities.
     */

    match /users/{userId} {
      allow read, write: if isOwner(userId);

      match /activities/{activityId} {
        allow read, write: if isOwner(userId);
      }
    }


    /**
     * ============================================================
     *  LAWYER PROFILES
     * ============================================================
     * Anyone logged in can READ lawyer profiles.
     * Only the lawyer THEMSELVES can create or update their own profile.
     */

    match /lawyers/{lawyerId} {

      // Logged-in users can view lawyers.
      allow get, list: if isLoggedIn();

      // Lawyer can create/update ONLY their own profile.
      allow create, update: if isOwner(lawyerId);
    }


    /**
     * ============================================================
     *  VERIFICATION REQUESTS
     * ============================================================
     *  - Users create requests.
     *  - Users can read ONLY their own requests.
     *  - Lawyer admin can read/list ALL requests.
     *  - Lawyer admin can update requests (approve / add comments).
     */

    match /verificationRequests/{requestId} {

      // Anyone logged in may create.
      allow create: if isLoggedIn();

      // Lawyer admin can LIST all requests (for lawyer-panel)
      allow list: if isLawyer();

      // Lawyer admin can read any request.
      // Users can read ONLY their request.
      allow get: if isLawyer()
                 || ( isLoggedIn()
                      && resource.data.userId == request.auth.uid );

      // Lawyer admin can update (approve, add comments, change status).
      allow update: if isLawyer();
    }


    /**
     * ============================================================
     *  PUBLIC READ-ONLY DATA
     * ============================================================
     */

    match /templates/{templateId} {
      allow get, list: if isLoggedIn();
      allow write: if false;
    }

    match /lawFeed/{updateId} {
      allow get, list: if isLoggedIn();
      allow write: if false;
    }

    match /glossary/{termId} {
      allow get, list: if isLoggedIn();
      allow write: if false;
    }


    /**
     * ============================================================
     *  GLOBAL RULES (APPLY TO EVERYTHING)
     * ============================================================
     * Prevent all deletes from client side.
     */

    match /{document=**} {
      allow delete: if false;
    }
  }
}
